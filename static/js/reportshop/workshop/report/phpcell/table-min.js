function TCRSTableView(){this.crsCellControler=new TCRSCellControler();this.op='<i align=\'right\'><img title="\u6dfb\u52a0" onclick="crsReport.crsCommon.crsTable.append_record(this)" src="/static/modules/reportshop/images/green_plus.gif" border="0" style="cursor:pointer"><img title="\u63d2\u5165" onclick="crsReport.crsCommon.crsTable.insert_record(this)" src="/static/modules/reportshop/images/green_arrow.gif" border="0" style="cursor:pointer"><img title="\u5220\u9664" onclick="crsReport.crsCommon.crsTable.delete_record(this)" src="/static/modules/reportshop/images/green_minus.gif" border="0" style="cursor:pointer"></i>'}TCRSTableView.prototype={constructor:TCRSTableView,loadData:function(x){var S=crsReport.crsTableIndex.get_sheet_sz();for(var X=0;X<S;X++){this.crsCellControler.cache_td(X)}if(x){var ak=crsReport.crsTableIndex.getFirstTable();while(ak!=null){var ac=ak[1]-1;var ae=rectNameToIndex(ak[5]);if(ak[3]<1){ak[3]=1}if(ak[0]=="\u660e\u7ec6\u8868"){if(ak[2]=="\u6309\u884c\u5411\u4e0b"){if(ak[4]>ak[3]){crsReport.crsTableIndex.update_cell_refer(parseInt(ac)+1,ak[2],ae,ak[4]-ak[3],true);var O=ae[1].y-ae[0].y+1;ae[0].y+=O*(ak[3]-1);ae[1].y+=O*(ak[3]-1);this.crsCellControler.insert_row(this.crsCellControler.get_cell(ac,ae[0].x,ae[0].y),ac,ae[0].y,(ak[4]-ak[3]));this.crsCellControler.cache_td(ac)}}else{if(ak[2]=="\u6309\u5217\u5411\u53f3"){if(ak[4]>ak[3]){crsReport.crsTableIndex.update_cell_refer(parseInt(ac)+1,ak[2],ae,ak[4]-ak[3],true);var O=ae[1].x-ae[0].x+1;ae[0].x+=O*(ak[3]-1);ae[1].x+=O*(ak[3]-1);this.crsCellControler.insert_column(this.crsCellControler.get_cell(ac,ae[0].x,ae[0].y),ac,ae[0].x,(ak[4]-ak[3]));this.crsCellControler.cache_td(ac)}}}}ak=crsReport.crsTableIndex.getNextTable()}}if(crsReport.openMode=="write"&&crsReport.s_dataflow!=""){crsReport.openMode="edit"}if(crsReport.openMode=="edit"||crsReport.openMode=="read"||crsReport.openMode=="copynew"){if(crsReport.openMode=="read"){me2=crsReport;if(!crsReport.b_is_query){crsReport.b_is_query=true}}var W=14;var ab=crsReport.crsTableIndex.getFirstTable();while(ab!=null){var ac=ab[1]-1;var j=crsReport.crsTableIndex.get_first_data_item();var Y=null;var i=1;while(j!=null){if(Y==null){Y=j.schema;j=j.data}for(var X=0,T=Y.length/W;X<T;X++){if(crsReport.openMode=="copynew"&&X==0){j[Y[X*W+8]]=crsReport.crsTableIndex.create_row_kid(Y[X*W+6])}var U=Y[X*W+1],Z=Y[X*W+2];var ae=rectNameToIndex(Y[X*W+10]);if(i>1){if(ab[2]=="\u6309\u884c\u5411\u4e0b"||X*W+[2]=="\u4e0d\u6269\u5c55"){Z+=(ae[1].y-ae[0].y+1)*(i-1)}else{U+=(ae[1].x-ae[0].x+1)*(i-1)}}var R="row"+Z+"column"+U;var N=crsReport.obj_cell_maps[ac][R];if(ab[2]=="\u6309\u884c\u5411\u4e0b"||X*W+[2]=="\u4e0d\u6269\u5c55"){$(N).parent("#row"+Z).attr("rid",j[Y[X*W+8]])}else{$(N).attr("rid",j[Y[X*W+8]])}$(N).attr("cid",Y[X*W+6]);if((crsReport.openMode=="copynew"&&(crsReport.writeColList==null||crsReport.writeColList.indexOf(Y[X*W+6])!=-1)||crsReport.openMode!="copynew"&&(crsReport.readColList==null||crsReport.readColList.indexOf(Y[X*W+6])!=-1))&&(Y[X*W+12]!="\u662f"||$(N).html()==""||$(N).html()==undefined)){var ah="";if(j[Y[X*W+7]]=="null"){ah=""}else{ah=HandleMemoStr(j[Y[X*W+7]],false)}$(N).attr("pval",ah);if(Y[X*W+12]=="\u662f"){$(N).attr("val2",ah)}else{if(Y[X*W+4]=="\u65e5\u671f\u578b"||Y[X*W+4]=="\u8d27\u5e01\u578b"||Y[X*W+4]=="\u6570\u503c\u578b"){if((Y[X*W+4]=="\u8d27\u5e01\u578b"||Y[X*W+4]=="\u6570\u503c\u578b")&&parseFloat(ah)==0||ah=="0"||ah=="0000-00-00 00:00:00"||ah=="0000-00-00"||ah=="00:00:00"){ah="";$(N).attr("pval",ah)}}else{if(Y[X*W+4]=="\u81ea\u589e\u578b"){ah=i;$(N).attr("pval",ah)}else{if(Y[X*W+4]=="\u4ee3\u7801\u578b"){}else{if(Y[X*W+4]=="\u56fe\u7247\u578b"){if(ah!=""){var ak=ah.split(" ");$(N).attr("val2",ak[0])}}else{if(Y[X*W+4]=="\u9644\u4ef6\u578b"){if(ah){$(N).attr("val2",ah)}}}}}}var Q={val:ah};var V=crsReport.crsTableIndex.getAColSchema(Y[X*W+6]);var al=crsReport.crsCommon._get_editor(j[Y[X*W+8]],V,Q);if(crsReport.openMode!="read"&&!crsReport.b_is_query&&X==T-1&&(ab[2]=="\u6309\u884c\u5411\u4e0b"||ab[2]=="\u6309\u5217\u5411\u53f3")){$(N).html(al+this.op)}else{$(N).html(al)}if(Y[X*W+4]=="\u4ee3\u7801\u578b"){$(N).children("input").width($(N).width()-32)}if(crsReport.openMode!="read"&&!crsReport.b_is_query&&X==T-1&&(ab[2]=="\u6309\u884c\u5411\u4e0b"||ab[2]=="\u6309\u5217\u5411\u53f3")){var P=$(N).children("input").width()-50;if(P>10){$(N).children("input").width(P)}}if(Y[X*W+4]!="\u56fe\u7247\u578b"&&Y[X*W+4]!="\u9644\u4ef6\u578b"){this.crsCellControler.set_cell_value(ac,U,Z,ah)}if(Y[X*W+5]!=""&&Y[X*W+5]!="0"&&$(N).html()!=""){$(N).html('<a onclick="crsReport.on_dblclick(event); return false;" href="#">'+$(N).html()+"</a>")}if(Q.val!=ah){if($(N).attr("val")!=null&&$(N).attr("val")==ah){$(N).attr("val",Q.val)}if($(N).attr("pval")!=null&&$(N).attr("pval")==ah){$(N).attr("pval",Q.val)}if($(N).attr("val2")!=null&&$(N).attr("val2")==ah){$(N).attr("val2",Q.val)}}}}else{if($(N).html()!=""&&$(N).html()!=undefined){$(N).attr("pval",$(N).val());this.crsCellControler.set_cell_value(ac,U,Z,$(N).val())}}}j=crsReport.crsTableIndex.get_next_data_item();i++}ab=crsReport.crsTableIndex.getNextTable()}}if(crsReport.openMode!="read"){j=crsReport.crsTableIndex.GetFirstWritableCellList(crsReport.writeColList);var ad=15;while(j!=null&&j.length>0){var M=j[5];var aj=j[4];var ac=j[2]-1;if(ac>0){this.crsCellControler.cache_td(ac)}for(var K=0;K<M;K++){var O=0;if(M>1){if(aj=="\u6309\u5217\u5411\u53f3"||aj=="\u4e0d\u6269\u5c55\uff08\u6309\u5217\u5411\u53f3\uff09"){var O=j[0].arr_cell_rect[1].x-j[0].arr_cell_rect[0].x+1}else{var O=j[0].arr_cell_rect[1].y-j[0].arr_cell_rect[0].y+1}}var L="";var X=0,ai=j.length/ad;for(;X<ai;X++){var y=j[X*ad].arr_cell_rect;var ag=y[0].x,af=y[0].y;if(K>0){if(aj=="\u6309\u5217\u5411\u53f3"||aj=="\u4e0d\u6269\u5c55\uff08\u6309\u5217\u5411\u53f3\uff09"){ag+=O*K}else{af+=O*K}}var R="row"+af+"column"+ag;var N=crsReport.obj_cell_maps[ac][R];if($(N).attr("cid")!=undefined){break}if($(N).attr("cid")==undefined){$(N).attr("cid",j[X*ad+13])}if(aj=="\u6309\u5217\u5411\u53f3"||aj=="\u4e0d\u6269\u5c55\uff08\u6309\u5217\u5411\u53f3\uff09"){if(L==""){L=crsReport.crsTableIndex.create_row_kid(j[X*ad+13])}if($(N).attr("rid")==undefined){$(N).attr("rid",L)}}else{if($(N).parent("#row"+af).attr("rid")==undefined){if(L==""){L=crsReport.crsTableIndex.create_row_kid(j[X*ad+13])}$(N).parent("#row"+af).attr("rid",L)}}var ah=this.crsCellControler.get_cell_value(ac,ag,af);if(j[X*ad+6]=="\u81ea\u589e\u578b"){j[X*ad+7]=K+1}var aa=crsReport.get_val_from_para(j[X*ad+13]);if(aa!=""){j[X*ad+7]=aa}if(ah==""){ah=$(N).html();if(ah==undefined){ah=""}if(ah!=""){ah=ah.decodeHtml();this.crsCellControler.set_cell_value(ac,ag,af,ah);if(s_title_schema.name!=""){if(title_schema==""){title_schema=s_title_schema.name.replaceAll(j[X*ad+13],format_text(j[X*ad+13],ah))}else{title_schema=title_schema.replaceAll(j[X*ad+13],format_text(j[X*ad+13],ah))}}if(crsReport.s_subtitle_schema!=""){if(subtitle_schema==""){subtitle_schema=crsReport.s_subtitle_schema.replaceAll(j[X*ad+13],format_text(j[X*ad+13],ah))}else{subtitle_schema=subtitle_schema.replaceAll(j[X*ad+13],format_text(j[X*ad+13],ah))}}}}if(ah==""&&j[X*ad+7]!=""){ah=j[X*ad+7];if(j[X*ad+8]!="\u662f"){this.crsCellControler.set_cell_value(ac,ag,af,j[X*ad+7])}else{$(N).attr("val2",j[X*ad+7])}if(s_title_schema.name!=""){if(title_schema==""){title_schema=s_title_schema.name.replaceAll(j[X*ad+13],format_text(j[X*ad+13],j[X*ad+7]))}else{title_schema=title_schema.replaceAll(j[X*ad+13],format_text(j[X*ad+13],j[X*ad+7]))}}if(crsReport.s_subtitle_schema!=""){if(subtitle_schema==""){subtitle_schema=crsReport.s_subtitle_schema.replaceAll(j[X*ad+13],format_text(j[X*ad+13],j[X*ad+7]))}else{subtitle_schema=subtitle_schema.replaceAll(j[X*ad+13],format_text(j[X*ad+13],j[X*ad+7]))}}}var Q={val:ah};var V=crsReport.crsTableIndex.getAColSchema(j[X*ad+13]);var al=crsReport.crsCommon._get_editor(L,V,Q);if(Q.val!=ah){if($(N).attr("val")!=null&&$(N).attr("val")==ah){$(N).attr("val",Q.val)}if($(N).attr("pval")!=null&&$(N).attr("pval")==ah){$(N).attr("pval",Q.val)}if($(N).attr("val2")!=null&&$(N).attr("val2")==ah){$(N).attr("val2",Q.val)}}if(!crsReport.b_is_query&&X==ai-1&&(aj=="\u6309\u884c\u5411\u4e0b"||aj=="\u6309\u5217\u5411\u53f3")){$(N).html(al+this.op)}else{$(N).html(al)}if(j[X*ad+6]=="\u4ee3\u7801\u578b"){$(N).children("input").width($(N).width()-32)}if(!crsReport.b_is_query&&X==ai-1&&(aj=="\u6309\u884c\u5411\u4e0b"||aj=="\u6309\u5217\u5411\u53f3")){var P=$(N).children("input").width()-50;if(P>10){$(N).children("input").width(P)}}}}j=crsReport.crsTableIndex.GetNextWritableCellList(crsReport.writeColList)}}if(crsReport.openMode=="edit"&&crsReport.s_data_flow!=""){crsReport.openMode="write"}},append_record:function(v){var r=$(v).parent().parent("td");if(crsReport.crsTableIndex!=null){var s=crsReport.crsTableIndex.can_append(r,true);if(s.b_can_append){var t="";crsReport.crsCommon.blur_handler();if(s.expandtype=="\u6309\u884c\u5411\u4e0b"){var q=rectNameToIndex(s.def_rect);var z=this.crsCellControler.get_sheet_index_by_cell(r);t=$(r).attr("cid");crsReport.crsTableIndex.update_cell_refer(parseInt(z)+1,s.expandtype,q,1,true);var i=q[1].y-q[0].y+1;this.crsCellControler.insert_row(r,z,q[0].y+i*(s.initcz-1),1);this.crsCellControler.cache_td(z);var C=q[0].y+i*s.initcz;var B="row"+C+"column"+q[0].x;$(crsReport.obj_cell_maps[z][B]).parent("#row"+C).attr("rid",crsReport.crsTableIndex.create_row_kid(t));if(s.arr_noclear!=undefined){for(var x=0,u=s.arr_noclear.length;x<u;x++){var D=rectNameToIndex(s.arr_noclear[x]);var y=crsReport.crsCommon.get_cell_value(z,D[0].x,q[0].y);crsReport.crsCommon.set_cell_value(z,D[0].x,q[0].y+i,y)}}if(s.arr_defaultval!=undefined){for(var x=0,u=s.arr_defaultval/2;x<u;x++){var D=rectNameToIndex(s.arr_defaultval[x*2]);this.crsCellControler.crsCommon(z,D[0].x,q[0].y+i,s.arr_defaultval[x*2+1])}}}else{if(s.expandtype=="\u6309\u5217\u5411\u53f3"){var q=rectNameToIndex(s.def_rect);var z=this.crsCellControler.get_sheet_index_by_cell(r);t=$(r).attr("cid");crsReport.crsTableIndex.update_cell_refer(parseInt(z)+1,s.expandtype,q,1,true);var i=q[1].x-q[0].x+1;this.crsCellControler.insert_column(z,q[0].x+i*(s.initcz-1),1);this.crsCellControler.cache_td(z);var C=q[0].x+i*s.initcz;var A=crsReport.crsTableIndex.create_row_kid(t);for(var x=q[0].y;x<=q[1].y;){var B="row"+x+"column"+C;var w=$(crsReport.obj_cell_maps[z][B]);w.attr("rid",A);if(w.attr("rowspan")!=undefined){x+=parseInt(w.attr("rowspan"))}else{x+=1}}if(s.arr_noclear!=undefined){for(var x=0,u=s.arr_noclear.length;x<u;x++){var D=rectNameToIndex(s.arr_noclear[x]);var y=this.crsCellControler.get_cell_value(z,q[0].x,D[0].y);this.crsCellControler.set_cell_value(z,q[0].x+i,D[0].y,y)}}if(s.arr_defaultval!=undefined){for(var x=0,u=s.arr_defaultval/2;x<u;x++){var D=rectNameToIndex(s.arr_defaultval[x*2]);this.crsCellControler.set_cell_value(z,q[0].x+i,D[0].y,s.arr_defaultval[x*2+1])}}}}if(t!=""){crsReport.crsTableIndex.auto_increment(t)}}}},insert_record:function(u){var p=$(u).parent().parent("td");if(crsReport.crsTableIndex!=null){var r=crsReport.crsTableIndex.can_append(p,true);if(r.b_can_append){var s="";crsReport.crsCommon.blur_handler();if(r.expandtype=="\u6309\u884c\u5411\u4e0b"){var i=rectNameToIndex(r.def_rect);var y=this.crsCellControler.get_sheet_index_by_cell(p);s=$(p).attr("cid");var q=this.crsCellControler.get_cell_point(p);crsReport.crsTableIndex.update_cell_refer(parseInt(y)+1,r.expandtype,i,1,true);this.crsCellControler.insert_row(p,y,q.y,1,true);this.crsCellControler.cache_td(y);var A="row"+q.y+"column"+ +q.x;$(crsReport.obj_cell_maps[y][A]).parent("#row"+q.y).attr("rid",crsReport.crsTableIndex.create_row_kid(s));if(r.arr_noclear!=undefined){for(var w=0,t=r.arr_noclear.length;w<t;w++){var B=rectNameToIndex(r.arr_noclear[w]);var x=crsReport.crsCommon.get_cell_value(y,B[0].x,i[0].y);crsReport.crsCommon.set_cell_value(y,B[0].x,i[0].y+i_sz,x)}}if(r.arr_defaultval!=undefined){for(var w=0,t=r.arr_defaultval/2;w<t;w++){var B=rectNameToIndex(r.arr_defaultval[w*2]);crsReport.crsCommon.set_cell_value(y,B[0].x,i[0].y+i_sz,r.arr_defaultval[w*2+1])}}}else{if(r.expandtype=="\u6309\u5217\u5411\u53f3"){var i=rectNameToIndex(r.def_rect);var y=this.crsCellControler.get_sheet_index_by_cell(p);var q=this.crsCellControler.get_cell_point(p);s=$(p).attr("cid");crsReport.crsTableIndex.update_cell_refer(parseInt(y)+1,r.expandtype,i,1,true);this.crsCellControler.insert_column(y,q.x,1,true);this.crsCellControler.cache_td(y);var z=crsReport.crsTableIndex.create_row_kid(s);for(var w=i[0].y;w<=i[1].y;){var A="row"+w+"column"+q.x;var v=$(crsReport.obj_cell_maps[y][A]);v.attr("rid",z);if(v.attr("rowspan")!=undefined){w+=parseInt(v.attr("rowspan"))}else{w+=1}}if(r.arr_noclear!=undefined){for(var w=0,t=r.arr_noclear.length;w<t;w++){var B=rectNameToIndex(r.arr_noclear[w]);var x=this.crsCellControler.get_cell_value(y,B[0].x,i[0].y);this.crsCellControler.set_cell_value(y,B[0].x+i_sz,i[0].y,x)}}if(r.arr_defaultval!=undefined){for(var w=0,t=r.arr_defaultval/2;w<t;w++){var B=rectNameToIndex(r.arr_defaultval[w*2]);this.crsCellControler.set_cell_value(y,B[0].x+i_sz,i[0].y,r.arr_defaultval[w*2+1])}}}}if(s!=""){crsReport.crsTableIndex.auto_increment(s)}}}},delete_record:function(m,j){if(j==undefined){j=$(m).parent().parent("td")}if(crsReport.crsTableIndex!=null){var n=crsReport.crsTableIndex.can_delete(j,true);if(n.b_can_delete){if(n.b_all){alert("\u660e\u7ec6\u8868\u6700\u540e\u4e00\u6761\u8bb0\u5f55\u4e0d\u80fd\u5220\u9664\uff01");return}var k="";crsReport.blur_handler();if(n.expandtype=="\u6309\u884c\u5411\u4e0b"){var o=rectNameToIndex(n.def_rect);var p=this.crsCellControler.get_sheet_index_by_cell(j);k=$(j).attr("cid");var i=this.crsCellControler.get_cell_point(j);crsReport.crsTableIndex.update_cell_refer(parseInt(p)+1,n.expandtype,o,1,false);crsReport.crsTableIndex.delete_row_kid($(j).parent("#row"+i.y).attr("rid"));this.crsCellControler.delete_row(j,p,i.y,1);this.crsCellControler.cache_td(p);var l=i.y-1;j=crsReport.obj_cell_maps[p]["row"+l+"column"+i.x]}else{if(n.expandtype=="\u6309\u5217\u5411\u53f3"){var o=rectNameToIndex(n.def_rect);var p=this.crsCellControler.get_sheet_index_by_cell(j);var i=this.crsCellControler.get_cell_point(j);crsReport.crsTableIndex.update_cell_refer(parseInt(p)+1,n.expandtype,o,1,false);crsReport.crsTableIndex.delete_row_kid($(j).attr("rid"));this.crsCellControler.delete_column(p,i.x,1);this.crsCellControler.cache_td(p);var l=i.x-1;j=crsReport.obj_cell_maps[p]["row"+i.y+"column"+l]}}if(k!=""){crsReport.crsTableIndex.auto_increment(k)}}}}};
