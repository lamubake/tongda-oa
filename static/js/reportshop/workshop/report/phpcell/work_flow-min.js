function TCRSWorkflow(c,d){this.crsDataSet=c;this.i_repid=d;TCRSDataRecord.call(this,this.crsDataSet,"crscell.crs_workflow","*","repid='"+d+"'","id")}TCRSWorkflow.prototype=new TCRSDataRecord();TCRSWorkflow.prototype.get_begin_task=function(){this.loadData("#tablecrs_workflow");var d="";var e=this.get_valid_task(crsReport.s_cur_task);if(!this.isEmpty()){var f=this.first();while(!this.EOF()){if(f.is_begin=="\u662f"){d=f.label}if(f.is_end=="\u662f"){if(e==f.label||e==""&&f.is_begin=="\u662f"){crsReport.b_is_endtask=true}}if(d!=""&&crsReport.b_is_endtask){break}f=this.next()}}return d};TCRSWorkflow.prototype.get_valid_task=function(d){var c=d.indexOf("(");if(c!=-1){return d.substr(0,c)}else{return d}};TCRSWorkflow.prototype.getColumnList=function(J,L,G,C,F,I){var M=crsReport.get_valid_cur_task();var H=this.search("label",M);if(H!=null){var i="",K="";var G=","+G+L+",";var F=","+F+C+",";if(H.column_list!=""){var N=HandleMemoStr(H.column_list,false).split("|");var z=5;var v=crsReport.crsReportState.get_prev_writer(crsReport.s_cur_task);for(var A=0,y=N.length/z;A<y;A++){var x=N[A*z],B=N[A*z+1];if(x=="0"){x=crsReport.crsUserCache.get_dept_and_priv(v).dept}if(B=="\u6d41\u7a0b\u53d1\u8d77\u4eba"&&crsReport.s_writer==crsReport.s_userid){if(N[A*z+4]!=""){if(crsReport.s_read_filter!=""){crsReport.s_read_filter+=" or "}crsReport.s_read_filter+=N[A*z+4]}var w=N[A*z+3];if(w!=""&&w!="--\u5b57\u6bb5\u5217\u8868--"){if(i!=""){i+=","}i+=w}var w=N[A*z+2];if(w!=""&&w!="--\u5b57\u6bb5\u5217\u8868--"){if(K!=""){K+=","}K+=w}}if(B=="\u4e0a\u4e00\u6b65\u6267\u884c\u4eba"){if(v==crsReport.s_writer){if(N[A*z+4]!=""){if(crsReport.s_read_filter!=""){crsReport.s_read_filter+=" or "}crsReport.s_read_filter+=N[A*z+4]}var w=N[A*z+3];if(w!=""&&w!="--\u5b57\u6bb5\u5217\u8868--"){if(i!=""){i+=","}i+=w}var w=N[A*z+2];if(w!=""&&w!="--\u5b57\u6bb5\u5217\u8868--"){if(K!=""){K+=","}K+=w}}}if(B==J+"."||G.indexOf(","+x+",")!=-1||F.indexOf(","+B+",")!=-1||in_assign_user(x,B,crsReport.s_assign_user)){if(B==""||x==""||in_assign_role(B,F)||crsReport.crsDeptCache.is_dept_manager(J,x,B)){if(N[A*z+4]!=""){if(crsReport.s_read_filter!=""){crsReport.s_read_filter+=" or "}crsReport.s_read_filter+=N[A*z+4]}var w=N[A*z+3];if(w!=""&&w!="--\u5b57\u6bb5\u5217\u8868--"){if(i!=""){i+=","}i+=w}var w=N[A*z+2];if(w!=""&&w!="--\u5b57\u6bb5\u5217\u8868--"){if(K!=""){K+=","}K+=w}}}if(is_ref_cell(B)){var E=crsReport.crsTableIndex.get_cell_value(B,1);E=crsReport.crsUserCache.get_id_list_by_name(E);var D=E.split(",");if(D.indexOf(crsReport.s_writer)!=-1){if(N[A*z+4]!=""){if(crsReport.s_read_filter!=""){crsReport.s_read_filter+=" or "}crsReport.s_read_filter+=N[A*z+4]}var w=N[A*z+3];if(w!=""&&w!="--\u5b57\u6bb5\u5217\u8868--"){if(i!=""){i+=","}i+=w}var w=N[A*z+2];if(w!=""&&w!="--\u5b57\u6bb5\u5217\u8868--"){if(K!=""){K+=","}K+=w}}}}}if(K!=""){crsReport.writeColList=K.split(",")}else{crsReport.writeColList=[]}if(i!=""){crsReport.readColList=i.split(",")}}};TCRSWorkflow.prototype.get_role_list_by_organ=function(l,k){var i=this.search("label",l);if(i!=null){if(i.column_list!=""){var g=HandleMemoStr(i.column_list,false).split(",");for(var j=0,h=g.length/5;j<h;j++){if(g[j*5]==k){return g[j*5+1]}}}}return""};TCRSWorkflow.prototype.get_task_candidate=function(w){var i=this.search("label",w);var H=[],x=[];var D=false;if(i==null||i.is_begin=="\u662f"){var p=null;D=true;if(crsReport.s_can_roll_back!="y"){p=crsReport.crsReportState.get_writer_list("")}if(p!=null){x=p.arr_userid;for(var A=0,y=x.length;A<y;A++){if(x[A].indexOf(".")==-1){x[A]+="."+crsReport.crsUserCache.get_name_by_id(x[A])}}}else{if(crsReport.s_write_mode!=""){H=HandleMemoStr(crsReport.s_write_organ,false).split(";");x=HandleMemoStr(crsReport.s_write_role,false).split(";")}}}else{var p=null;if(crsReport.s_can_roll_back!="y"){p=crsReport.crsReportState.get_writer_list(w)}if(p!=null){x=p.arr_userid;for(var A=0,y=x.length;A<y;A++){if(x[A].indexOf(".")==-1){x[A]+="."+crsReport.crsUserCache.get_name_by_id(x[A])}}}else{H=HandleMemoStr(i.priv_organ,false).split(",");x=HandleMemoStr(i.priv_role,false).split(",")}}var v={};if(x.indexOf("\u4e0a\u4e00\u6b65\u6267\u884c\u4eba")!=-1){v[crsReport.s_writer]=crsReport.crsUserCache.get_name_by_id(crsReport.s_writer)}if(x.indexOf("\u6d41\u7a0b\u53d1\u8d77\u4eba")!=-1){if(v[crsReport.userId]==undefined){v[crsReport.userId]=crsReport.crsUserCache.get_name_by_id(crsReport.userId)}}for(var A=0,y=x.length;A<y;A++){var G=x[A].indexOf(".");if(G!=-1){var t=x[A].substr(0,G);if(v[t]==undefined){v[t]=crsReport.crsUserCache.get_name_by_id(t)}}else{if(is_ref_cell(x[A])){var E=crsReport.crsTableIndex.getAColSchema(x[A]);var u=rectNameToIndex(E.col.rows[E.col_idx].cellspan);var B=crsReport.crsCommon.get_cell_value(0,u[0].x,u[0].y);if(B!=""){if(B.charAt(B.length-1)!=","){var t=crsReport.crsUserCache.get_id_by_name(B);if(v[t]==undefined){v[t]=B}}else{var z=B.split(",");for(var A=0,y=z.length-1;A<y;A++){if(v[z[A]]==undefined){v[z[A]]=crsReport.crsUserCache.get_name_by_id(z[A])}}}}}else{var C=crsReport.crsUserCache.get_user_list_by_priv(x[A]);for(s_key in C){if(v[s_key]==undefined){v[s_key]=C[s_key]}}}}}for(var A=0,y=H.length;A<y;A++){var F="";if(D){F=crsReport.crsPrivCache.get_role_list_by_organ(H[A])}else{F=this.get_role_list_by_organ(w,H[A])}var C=null;if(H[A]=="0"){C=crsReport.crsUserCache.get_user_list_by_dept(crsReport.s_writer_organid,F)}else{C=crsReport.crsUserCache.get_user_list_by_dept(H[A],F)}for(s_key in C){if(v[s_key]==undefined){v[s_key]=C[s_key]}}}return v};TCRSWorkflow.prototype.get_schedule=function(d){var f="\u62a2\u5148\u5f0f";this.loadData("#tablecrs_workflow");if(d==""){d=crsReport.s_begin_task}else{d=this.get_valid_task(d)}var e=this.search("label",d);if(e!=null){f=e.schedulemode;if(this.is_begin=="\u662f"){if(crsReport.s_write_mode=="y"){f="\u5e76\u5217\u5f0f"}else{if(crsReport.s_write_mode=="2"){f="\u8865\u5145\u5f0f"}}}}return f};TCRSWorkflow.prototype.get_next_task=function(_b_redirect){var obj_res=null;if(crsReport.s_cur_task==""){var s_state=crsReport.crsReportState.get_task_state(crsReport.s_cur_task,crsReport.s_writer);if(s_state!="done"&&crsReport.s_write_mode!=""){if(crsReport.s_write_mode=="y"){if(s_state=="unknown"){var obj_candidate=this.get_task_candidate(crsReport.s_begin_task);if(obj_candidate!=null&&obj_length(obj_candidate)>1){return obj_res}}else{return obj_res}}}}else{var s_cur_task=this.get_valid_task(crsReport.s_cur_task);var row=this.search("label",s_cur_task);if(row!=null){if(row.schedulemode=="\u4f1a\u7b7e\u5f0f"||row.schedulemode=="\u5e76\u5217\u5f0f"||(row.is_begin="\u662f"&&crsReport.s_write_mode=="y")){var s_state=crsReport.crsReportState.get_task_state(s_cur_task,crsReport.s_writer);if(s_state==""){return obj_res}}}}var s_cur_task=crsReport.s_cur_task;if(s_cur_task==""){s_cur_task=crsReport.s_begin_task}if(!this.isEmpty()){var row=this.first();while(!this.EOF()){if(row.is_link=="\u662f"){var s_para=HandleMemoStr(row.para,false);if(s_para!=""){var p=s_para.indexOf(" "),p2=s_para.indexOf(",",p+1),p3=s_para.indexOf(" ",p2+1);var b_task=s_para.substring(0,p),e_task=s_para.substring(p2+1,p3);if(b_task==s_cur_task){var s="1";if(row.convexpr!=""&&row.convexpr!="\u624b\u52a8\u6267\u884c"){var s_where=HandleMemoStr(row.convexpr,false),s_tab="",s_from="";var obj_tab_row=crsReport.crsTableIndex.first();while(!crsReport.crsTableIndex.EOF()){var str="crscell.crs_tabledata"+obj_tab_row.id+"c";var p=s_where.indexOf(str),p2;if(p!=-1){p2=p+str.length;while(is_digit_char(s_where.charAt(p2))){p2++}str=s_where.substring(p,p2);s_tab=crsReport.crsTableIndex.get_cur_tab_name(obj_tab_row.id);if(s_from!=""){s_from+=" join "}s_from+=s_tab;s_where=s_where.replaceAll(str,s_tab)}obj_tab_row=crsReport.crsTableIndex.next()}var s_sql="",s_snapshot_sql="";if(s_from!=""){s_snapshot_sql=crsReport.crsTableIndex.create_cur_table_data(false);s_sql="select 1 as a from "+s_from+" where "+s_where}else{s_sql="select "+s_where+" as a"}s=eval(crsReport.crsDataSet.execQuery(s_sql,undefined,undefined,undefined,s_from.replaceAll(" join ",","),s_snapshot_sql))}if(s=="1"||s.length>0&&s[0].a=="1"){var obj_u=this.get_task_candidate(e_task);if(obj_res==null){obj_res={}}var row2=this.search("label",e_task);if(row2!=null){obj_res[row2.id]={n:e_task,u:obj_u,b_only_redirect:row2.onlyredirect=="\u662f"}}}}}}row=this.next()}}return obj_res};
