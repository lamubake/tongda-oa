function TCRSChart(c,d){this.i_repid=d;this.crsDataSet=c;TCRSDataRecord.call(this,this.crsDataSet,"crscell.crs_chart","*","repid='"+d+"'","");this.obj_series_ref_col=null;this.arr_colors=["#2f7ed8","#e0522f","#ffcc00","#10cca6","#6bb61d","#f2a21a","#ff7372","#a5e8d2","#9ce810","#fff80a","#1dcfab","#858e54"];this.f_min_val=null;this.f_max_val=null;this.b_rotation=false;this.i_max_len=0}TCRSChart.prototype=new TCRSDataRecord();TCRSChart.prototype.get_chart_type=function(c){var d={s_type:"column",b_stacked:false};switch(c){case"\u67f1\u72b6\u56fe":break;case"\u6808\u67f1\u72b6\u56fe":d.b_stacked=true;break;case"\u6761\u5f62\u56fe":d.s_type="bar";break;case"\u6808\u6761\u5f62\u56fe":d.s_type="bar";d.b_stacked=true;break;case"\u6298\u7ebf\u56fe":d.s_type="line";break;case"\u997c\u72b6\u56fe":d.s_type="pie";break;case"\u9762\u79ef\u56fe":d.s_type="area";break;case"\u6808\u9762\u79ef\u56fe":d.s_type="area";d.b_stacked=true;break;case"\u6563\u70b9\u56fe":d.s_type="scatter";break;case"\u6c14\u6ce1\u56fe":d.s_type="bubble";break;case"\u96f7\u8fbe\u56fe":d.s_type="polar";break;case"\u4eea\u8868\u76d8":d.s_type="gauge";break;default:break}return d};TCRSChart.prototype.get_categories=function(j){if(j.xrange==""){if(j.category_name!=""){return j.category_name.split(",")}else{if(j.series_name!=""){return j.series_name.split(",")}return null}}var i=HandleMemoStr(j.xrange,false).split(",");var p=[];var m=0;for(var r=0,o=i.length;r<o;r++){var n=rectNameToIndex(i[r]);if(j.orientation=="toptobottom"){for(var q=n[0].y;q<=n[1].y;q++){var l=crsReport.crsCommon.get_cell_value(j.sheetindex,n[0].x,q);p.push(l);m+=p[p.length-1].length;if(this.i_max_len<p[p.length-1].length){this.i_max_len=p[p.length-1].length}}}else{for(var q=n[0].x;q<=n[1].x;q++){var l=crsReport.crsCommon.get_cell_value(j.sheetindex,q,n[0].x);p.push(l);m+=p[p.length-1].length;if(this.i_max_len<p[p.length-1].length){this.i_max_len=p[p.length-1].length}}}}if(m>50){this.b_rotation=true}return p};TCRSChart.prototype.get_series=function(i){var v=[];if(i.series_name!=""){v=i.series_name.split(",")}var j=this.get_categories(i);if(j==null){j=[]}if(this.obj_series_ref_col==null){this.obj_series_ref_col={}}this.f_max_val=null;this.f_min_val=null;var A=[],k=[{type:"pie",name:v[0]!=""?v[0]:j[0],data:[]}];var F=HandleMemoStr(i.data_range,false).split(",");for(var E=0,y=F.length;E<y;E++){var x=rectNameToIndex(F[E]);var u,B="";if(i.orientation=="toptobottom"){for(var C=x[0].x,w=E;C<=x[1].x;C++,w++){u={name:v.length>w?v[w]:"\u7cfb\u5217 "+w,data:[],dial:{}};for(var D=x[0].y,t=0;D<=x[1].y;D++,t++){B=crsReport.crsCommon.get_cell_value(i.sheetindex,C,D);if(B==""){B=0}B=parseFloat(B);u.data.push(B);k[0].data.push([j[0]!=""&&j.length>t+w?j[t+w]:(v.length>t+w?v[t+w]:"\u7cfb\u5217 "+t+w),B]);if(i.chart_type=="\u4eea\u8868\u76d8"){u.dial.backgroundColor=this.arr_colors[w];if(this.f_min_val==null||this.f_min_val>B){this.f_min_val=B}if(this.f_max_val==null||this.f_max_val<B){this.f_max_val=B}u.dataLabels={enabled:false}}this.obj_series_ref_col[u.name+"_"+t]={};B=crsReport.crsCommon.get_cell_attr(i.sheetindex,C,D,"cid");this.obj_series_ref_col[u.name+"_"+t].col=B;var z=crsReport.crsTableIndex.getAColSchema(this.obj_series_ref_col[u.name+"_"+t].col);if(z!=null){this.obj_series_ref_col[u.name+"_"+t].seq=z.get_display_seq(C,D)-1}}A.push(u)}}else{for(var C=x[0].y,w=E;C<=x[1].y;C++,w++){u={name:v.length>w?v[w]:"\u7cfb\u5217 "+w,data:[],dial:{}};for(var D=x[0].x,t=0;D<=x[1].x;D++,t++){B=crsReport.crsCommon.get_cell_value(i.sheetindex,D,C);if(B==""){B=0}B=parseFloat(B);u.data.push(B);k[0].data.push([j[0]!=""&&j.length>t+w?j[t+w]:(v.length>t+w?v[t+w]:"\u7cfb\u5217 "+t+w),B]);if(i.chart_type=="\u4eea\u8868\u76d8"){u.dial.backgroundColor=this.arr_colors[w];if(this.f_min_val==null||this.f_min_val>B){this.f_min_val=B}if(this.f_max_val==null||this.f_max_val<B){this.f_max_val=B}u.dataLabels={enabled:false}}this.obj_series_ref_col[u.name+"_"+t]={};this.obj_series_ref_col[u.name+"_"+t].col=crsReport.crsCommon.get_cell_attr(i.sheetindex,D,C,"cid");var z=crsReport.crsTableIndex.getAColSchema(this.obj_series_ref_col[u.name+"_"+t].col);if(z!=null){this.obj_series_ref_col[u.name+"_"+t].seq=z.get_display_seq(D,C)-1}}A.push(u)}}}return(i.chart_type=="\u997c\u72b6\u56fe")?k:A};TCRSChart.prototype.draw_chart=function(O){var J=O.label;var K=$("#"+J);if($(K).length<=0){var S="row"+O.ycoordinate+"column"+O.xcoordinate;var N=crsReport.obj_cell_maps[O.sheetindex][S];var p=(O.aright-O.aleft+1)+"px",R=(O.abottom-O.atop+1)+"px";p="99%";R="96%";if(crsReport.i_width>0&&false){var K='<div id="'+J+'" style="min-width:450px;min-height:350px;position: absolute;left:'+$(N).offset().left+"; top:"+$(N).offset().top+";width:"+p+"; height:"+R+';z-index:1002;margin: 0 auto"></div>'}else{var K='<div id="'+J+'" style="min-width:450px;min-height:350px;position: absolute;left:'+$(N).offset().left+"; top:"+$(N).offset().top+";width:"+p+";height:"+R+';z-index:1002;margin: 0 auto"></div>'}if(crsReport.i_width<=0&&crsReport.i_height<=0){$(N).html($(K))}else{$("body").append($(K))}K=$("#"+J)}var A=this.get_chart_type(O.chart_type);if(A.s_type=="pie"){$(K).highcharts({chart:{plotBackgroundColor:null,plotBorderWidth:null,plotShadow:false,style:{fontFamily:"\u5b8b\u4f53",fontSize:"12px"}},title:{text:O.title,style:{fontFamily:"\u5b8b\u4f53",fontSize:"16px",fontweight:"bold"}},xAxis:{labels:{style:{fontFamily:"\u5b8b\u4f53",fontSize:"12px"}}},plotOptions:{pie:{allowPointSelect:true,cursor:"pointer",point:{events:{click:function(){var a=crsReport.crsTableIndex.get_ref_report(crsReport.crsChartCache.obj_series_ref_col[this.series.name+"_"+this.x].col,crsReport.crsChartCache.obj_series_ref_col[this.series.name+"_"+this.x].seq);if(a!=null){window.parent.link_report(a)}}}},dataLabels:{enabled:true,formatter:function(){return"<b>"+this.point.name+"</b>: "+this.y}}}},series:this.get_series(O),credits:{enabled:false},colors:this.arr_colors})}else{if(A.s_type=="gauge"){var Q=this.get_series(O);var I=[];if(O.color_span!=""){var V=HandleMemoStr(O.color_span,false).split(",");for(var F=0,E=V.length;F<E;F++){var L={};var H=V[F].indexOf("-");L.from=V[F].substring(1,H);var T=V[F].indexOf("]");L.to=V[F].substring(H+1,T);var U=parseInt(V[F].substr(T+1));L.color=get_color(U);I.push(L)}M=I[0].from;P=I[E-1].to}else{var D=0.5,B=0.5;var P=this.f_max_val*(1+B),M=this.f_min_val*(1-D),C=P-M;if(C==0){C=this.f_max_val}C/=3;I.push({from:M,to:M+C,color:"#DF5353"});I.push({from:M+C,to:M+2*C,color:"#DDDF0D"});I.push({from:M+2*C,to:P,color:"#55BF3B"})}var G=O.title;if(O.title==""){G=O.series_name}$(K).highcharts({chart:{type:"gauge",plotBackgroundColor:null,plotBackgroundImage:null,plotBorderWidth:0,plotShadow:false,style:{fontFamily:"\u5b8b\u4f53",fontSize:"12px"}},title:{text:G,style:{fontFamily:"\u5b8b\u4f53",fontSize:"16px",fontweight:"bold"}},pane:{startAngle:-120,endAngle:120,background:[{backgroundColor:{linearGradient:{x1:0,y1:0,x2:0,y2:1},stops:[[0,"#FFF"],[1,"#333"]]},borderWidth:0,outerRadius:"109%"},{backgroundColor:{linearGradient:{x1:0,y1:0,x2:0,y2:1},stops:[[0,"#333"],[1,"#FFF"]]},borderWidth:1,outerRadius:"107%"},{},{backgroundColor:"#DDD",borderWidth:0,outerRadius:"105%",innerRadius:"103%"}]},plotOptions:{series:{cursor:"pointer",point:{events:{click:function(){var a=crsReport.crsTableIndex.get_ref_report(crsReport.crsChartCache.obj_series_ref_col[this.series.name+"_"+this.x].col,crsReport.crsChartCache.obj_series_ref_col[this.series.name+"_"+this.x].seq);if(a!=null){window.parent.link_report(a)}}}},marker:{lineWidth:1},dataLabels:{enabled:true}}},yAxis:{min:M,max:P,minorTickInterval:"auto",minorTickWidth:1,minorTickLength:10,minorTickPosition:"inside",minorTickColor:"#666",tickPixelInterval:30,tickWidth:2,tickPosition:"inside",tickLength:10,tickColor:"#666",labels:{step:2,rotation:"auto"},plotBands:I},series:Q,credits:{enabled:false},colors:this.arr_colors})}else{if(A.s_type=="polar"){var i=this.get_categories(O);var Q=this.get_series(O);$(K).highcharts({chart:{polar:true,type:"line",marginRight:130,marginBottom:25,style:{fontFamily:"\u5b8b\u4f53",fontSize:"12px"}},title:{text:O.title,x:-20,style:{fontFamily:"\u5b8b\u4f53",fontSize:"16px",fontweight:"bold"}},xAxis:{categories:i,labels:{style:{fontFamily:"\u5b8b\u4f53",fontSize:"12px"}}},yAxis:{title:{text:""}},plotOptions:{series:{cursor:"pointer",point:{events:{click:function(){var a=crsReport.crsTableIndex.get_ref_report(crsReport.crsChartCache.obj_series_ref_col[this.series.name+"_"+this.x].col,crsReport.crsChartCache.obj_series_ref_col[this.series.name+"_"+this.x].seq);if(a!=null){window.parent.link_report(a)}}}},marker:{lineWidth:1},dataLabels:{enabled:(i.length*Q.length<=10)?true:false}}},legend:{layout:"vertical",align:"right",verticalAlign:"top",x:-10,y:100,borderWidth:0},series:Q,credits:{enabled:false},colors:this.arr_colors})}else{var i=this.get_categories(O);var Q=this.get_series(O);$(K).highcharts({chart:{type:A.s_type,marginLeft:A.s_type=="bar"?this.i_max_len*13:30,marginBottom:this.b_rotation?this.i_max_len*13:30,style:{fontFamily:"\u5b8b\u4f53",fontSize:"12px"}},title:{text:O.title,x:-20,style:{fontFamily:"\u5b8b\u4f53",fontSize:"16px",fontWeight:"bolder"}},xAxis:{categories:i,labels:{rotation:(this.b_rotation&&A.s_type!="bar")?-40:0,align:"right",style:{fontFamily:"\u5b8b\u4f53",fontSize:"12px"}}},yAxis:{title:{text:""}},plotOptions:{series:{stacking:A.b_stacked?"normal":"",cursor:"pointer",point:{events:{click:function(){var a=crsReport.crsTableIndex.get_ref_report(crsReport.crsChartCache.obj_series_ref_col[this.series.name+"_"+this.x].col,crsReport.crsChartCache.obj_series_ref_col[this.series.name+"_"+this.x].seq);if(a!=null){window.parent.link_report(a)}}}},marker:{lineWidth:1},dataLabels:{enabled:(i.length*Q.length<=10)?true:false}}},legend:{layout:"vertical",align:"right",verticalAlign:"top",x:-10,y:100,borderWidth:0,style:{fontFamily:'"\u5b8b\u4f53"',fontSize:"12px"}},series:Q,credits:{enabled:false},colors:this.arr_colors})}}}};TCRSChart.prototype.load_chart=function(){this.loadData("#tablecrs_chart");if(!crsReport.b_as_form){if(!this.isEmpty()){crsReport.crsCommon.crsTable.crsCellControler.cache_td(0);var b=this.first();while(!this.EOF()){b.label=getColPlatKId(b.label);b.category_name=HandleMemoStr(b.category_name,false);b.series_name=HandleMemoStr(b.series_name,false);this.draw_chart(b);b=this.next()}}}};TCRSChart.prototype.update_ref=function(l,j,g,h,k){if(!this.isEmpty()){var i=this.first();while(!this.EOF()){i.data_range=update_ref(l,j,g,i.data_range,h,k);i.xrange=update_ref(l,j,g,i.xrange,h,k);i=this.next()}}};TCRSChart.prototype.refresh=function(){if(!this.isEmpty()){var b=this.first();while(!this.EOF()){this.draw_chart(b);b=this.next()}}};TCRSChart.prototype.change_type=function(d){if(!this.isEmpty()){var c=this.first();while(!this.EOF()){c.chart_type=d;this.draw_chart(c);c=this.next()}}};TCRSChart.prototype.set_chart_actions=function(){if(!this.isEmpty()){var b=this.first();while(!this.EOF()){crsReport.crsCommon.add_action_maps(["chart",b.chart_type,(b.xrange=="")?b.category_name:b.xrange,b.series_name,b.data_range,b.orientation]);b=this.next()}}};
